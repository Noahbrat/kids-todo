<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Todo List</title>

    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-title" content="Morning Todo">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxkZWZzPgo8cmFkaWFsR3JhZGllbnQgaWQ9InN1bnNldCIgY3g9IjUwJSIgY3k9IjcwJSIgcj0iNjAlIj4KPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I0ZGRjNBMCIvPgo8c3RvcCBvZmZzZXQ9IjUwJSIgc3R5bGU9InN0b3AtY29sb3I6I0ZGQzY1NyIvPgo8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNGRjhBODAiLz4KPC9yYWRpYWxHcmFkaWVudD4KPC9kZWZzPgo8cGF0aCBkPSJNMCAwSDE4MFYxODBIMFoiIGZpbGw9InVybCgjc3Vuc2V0KSIvPgo8Y2lyY2xlIGN4PSI5MCIgY3k9IjEyMCIgcj0iMzUiIGZpbGw9IiNGRkY3Q0QiIHN0cm9rZT0iI0ZGRUMwMCIgc3Ryb2tlLXdpZHRoPSIzIi8+CjwhLS0gU3VuIHJheXMgLS0+CjxwYXRoIGQ9Ik05MCA2MEw5MCA0NSIgc3Ryb2tlPSIjRkZFQzAwIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTI1IDc3TDEzNSA2NyIgc3Ryb2tlPSIjRkZFQzAwIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTQyIDEyMEwxNTcgMTIwIiBzdHJva2U9IiNGRkVDMDAiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CjxwYXRoIGQ9Ik01NSA3N0w0NSA2NyIgc3Ryb2tlPSIjRkZFQzAwIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8cGF0aCBkPSJNMzggMTIwTDIzIDEyMCIgc3Ryb2tlPSIjRkZFQzAwIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8IS0tIENoZWNrbWFyayAtLT4KPHBhdGggZD0iTTcwIDEzNUw4MiAxNDdMTEwIDExOSIgc3Ryb2tlPSIjNENBRjUwIiBzdHJva2Utd2lkdGg9IjYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZmlsbD0ibm9uZSIvPgo8L3N2Zz4K">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGRlZnM+CjxyYWRpYWxHcmFkaWVudCBpZD0ic3Vuc2V0MzIiIGN4PSI1MCUiIGN5PSI3MCUiIHI9IjYwJSI+CjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNGRkYzQTAiLz4KPHN0b3Agb2Zmc2V0PSI1MCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNGRkM2NTciLz4KPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojRkY4QTgwIi8+CjwvcmFkaWFsR3JhZGllbnQ+CjwvZGVmcz4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSJ1cmwoI3N1bnNldDMyKSIgcng9IjQiLz4KPGNpcmNsZSBjeD0iMTYiIGN5PSIyMCIgcj0iNiIgZmlsbD0iI0ZGRjdDRCIgc3Ryb2tlPSIjRkZFQzAwIiBzdHJva2Utd2lkdGg9IjEiLz4KPHBhdGggZD0iTTE2IDEyTDE2IDEwIiBzdHJva2U9IiNGRkVDMDAiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+CjxwYXRoIGQ9Ik0yMiAxNkwyNCAxNiIgc3Ryb2tlPSIjRkZFQzAwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTAgMTZMOCAxNiIgc3Ryb2tlPSIjRkZFQzAwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPgo8cGF0aCBkPSJNMTIgMjRMMTUgMjEiIHN0cm9rZT0iIzRDQUY1MCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIGZpbGw9Im5vbmUiLz4KPC9zdmc+Cg==">
    <!-- Load optional config file (families will create this after forking) -->
    <script>
        // Try to load config file - if it doesn't exist, we'll use fallback values
        window.APP_CONFIG = window.APP_CONFIG || {};
    </script>
    <script src="config.js" onerror="console.log('No config.js found - using fallback configuration')"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            position: relative;
        }

        .sync-btn {
            position: absolute;
            right: 0;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sync-btn:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .sync-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .sync-icon {
            font-size: 1.2em;
            transition: transform 0.5s ease;
        }

        .sync-btn.syncing .sync-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        h1 {
            color: #333;
            font-size: 2.5em;
            font-weight: 600;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .mode-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.todo-mode {
            background: white;
            color: #333;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .mode-btn.edit-mode {
            background: #5b7fff;
            color: white;
            box-shadow: 0 2px 10px rgba(91, 127, 255, 0.3);
        }

        .mode-btn.inactive {
            background: #f0f0f0;
            color: #999;
            box-shadow: none;
        }

        .people-tabs {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .person-tab {
            padding: 10px 20px;
            font-size: 1.3em;
            font-weight: 600;
            color: #999;
            background: none;
            border: none;
            cursor: pointer;
            transition: color 0.3s ease;
            position: relative;
        }

        .person-tab.active {
            color: #5b7fff;
        }

        .person-tab.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            right: 0;
            height: 3px;
            background: #5b7fff;
            border-radius: 2px;
        }

        .tasks-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 15px;
        }

        .tasks-table th {
            padding: 10px;
            font-size: 1.3em;
            font-weight: 600;
            color: #666;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }

        .tasks-table th:first-child {
            font-size: 1.5em;
            font-weight: 700;
            color: #333;
        }

        .tasks-table th.active {
            color: #5b7fff;
            position: relative;
        }

        .tasks-table th.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 10%;
            right: 10%;
            height: 3px;
            background: #5b7fff;
            border-radius: 2px;
        }

        .tasks-table tr.task-row {
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .tasks-table tr.task-row:hover {
            background: #f0f1f3;
            transform: translateX(5px);
        }

        .tasks-table td {
            padding: 15px;
            text-align: center;
            border-radius: 12px;
        }

        .tasks-table td:first-child {
            text-align: left;
            font-size: 1.2em;
            color: #333;
            min-width: 200px;
            border-radius: 12px 0 0 12px;
        }

        .tasks-table td:last-child {
            border-radius: 0 12px 12px 0;
        }

        .task-input {
            padding: 8px 15px;
            border: 2px solid #5b7fff;
            border-radius: 20px;
            background: white;
            color: #5b7fff;
            font-size: 1em;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-block;
        }

        .task-input.na {
            border-color: #999;
            background: #999;
            color: white;
        }

        .task-checkbox {
            width: 30px;
            height: 30px;
            cursor: pointer;
            transform: scale(2);
        }

        .btn {
            padding: 6px 15px;
            border: none;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 2px;
        }

        .btn-edit {
            background: #4caf50;
            color: white;
        }

        .btn-edit:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #da190b;
            transform: scale(1.05);
        }

        .btn-move {
            background: #2196f3;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            min-width: 28px;
        }

        .btn-move:hover:not(:disabled) {
            background: #1976d2;
            transform: scale(1.05);
        }

        .btn-move:disabled {
            background: #ccc;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .reset-button-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .reset-btn {
            padding: 12px 30px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
        }

        .reset-btn:hover {
            background: #e55a2b;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        .add-task-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            background: #f0f7ff;
            border-radius: 12px;
            border: 2px dashed #5b7fff;
        }

        .add-task-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #5b7fff;
            border-radius: 8px;
            font-size: 1em;
        }

        .add-task-btn {
            padding: 10px 30px;
            background: #5b7fff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-task-btn:hover {
            background: #4a6ee0;
            transform: scale(1.05);
        }

        .emoji-picker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            padding: 60px 60px 120px 60px;
            z-index: 1000;
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            gap: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .emoji-picker-header {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }

        .emoji-close-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
            transition: all 0.2s ease;
        }

        .emoji-close-btn:hover {
            background: #da190b;
            transform: scale(1.1);
        }

        .emoji-option {
            background: none;
            border: none;
            font-size: 2.2em;
            cursor: pointer;
            padding: 12px;
            border-radius: 10px;
            transition: all 0.2s;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-option:hover {
            background-color: #f0f0f0;
        }

        .emoji-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
        }


        .message-area {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #fff9c4 0%, #ffe4e1 100%);
            border-radius: 15px;
            border: 2px solid #ffd700;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 1.1em;
            font-weight: 600;
            color: #8b4513;
        }

        .message-textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #ffd700;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1em;
            line-height: 1.5;
            resize: vertical;
            background: rgba(255, 255, 255, 0.8);
            outline: none;
            transition: border-color 0.3s ease;
        }

        .message-textarea:focus {
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .message-display {
            padding: 15px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            font-size: 1em;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            min-height: 60px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .message-display:empty::before {
            content: "No message today ‚ú®";
            color: #999;
            font-style: italic;
        }

        /* Celebration Animation Styles */
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .celebration-overlay.active {
            opacity: 1;
        }

        .celebration-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 100%);
            color: white;
            padding: 30px 40px;
            border-radius: 25px;
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: celebration-bounce 1s ease-out;
        }

        @keyframes celebration-bounce {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .celebration-emoji {
            position: absolute;
            font-size: 3em;
            animation: celebration-emoji-float 2s ease-out;
            pointer-events: none;
        }

        @keyframes celebration-emoji-float {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            20% {
                transform: scale(1.5) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(360deg) translateY(-100px);
                opacity: 0;
            }
        }

        .firework {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            animation: firework-explosion 1.5s ease-out;
        }

        @keyframes firework-explosion {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            20% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        .firework:nth-child(1) { background: #ff6b6b; }
        .firework:nth-child(2) { background: #4ecdc4; }
        .firework:nth-child(3) { background: #45b7d1; }
        .firework:nth-child(4) { background: #ffd93d; }
        .firework:nth-child(5) { background: #6c5ce7; }
        .firework:nth-child(6) { background: #a29bfe; }
        .firework:nth-child(7) { background: #fd79a8; }
        .firework:nth-child(8) { background: #00b894; }

        /* Mobile responsive adjustments for celebration */
        @media (max-width: 480px) {
            .celebration-message {
                font-size: 1.4em;
                padding: 20px 30px;
            }

            .celebration-emoji {
                font-size: 2.5em;
            }
        }

        .message-history {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fd 100%);
            border-radius: 15px;
            border: 2px solid #5b7fff;
            box-shadow: 0 4px 15px rgba(91, 127, 255, 0.1);
        }

        .message-history-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
            color: #5b7fff;
        }

        .history-count {
            background: #5b7fff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            margin-left: auto;
        }

        .message-history-list {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 10px;
        }

        .sample-message {
            opacity: 0.85;
            border-style: dashed !important;
        }

        .sample-message .history-date {
            color: #999;
            font-style: italic;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(91, 127, 255, 0.2);
            border-radius: 10px;
            margin-bottom: 10px;
            padding: 12px 15px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: #5b7fff;
            transform: translateX(3px);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #666;
        }

        .history-date {
            font-weight: 500;
        }

        .history-actions {
            display: flex;
            gap: 5px;
        }

        .history-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-btn-load {
            background: #4caf50;
            color: white;
        }

        .history-btn-load:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .history-btn-delete {
            background: #f44336;
            color: white;
        }

        .history-btn-delete:hover {
            background: #da190b;
            transform: scale(1.05);
        }

        .history-message {
            color: #333;
            line-height: 1.4;
            font-size: 0.95em;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .hidden {
            display: none;
        }

        /* Setup Wizard Styles */
        .setup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .setup-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .setup-wizard {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .setup-wizard h2 {
            color: #5b7fff;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .setup-wizard p {
            color: #666;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .children-setup {
            margin-bottom: 30px;
        }

        .child-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .child-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1em;
            transition: border-color 0.3s ease;
        }

        .child-input:focus {
            outline: none;
            border-color: #5b7fff;
        }

        .child-input.error {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.05);
        }

        .remove-child-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.2s ease;
        }

        .remove-child-btn:hover {
            background: #da190b;
            transform: scale(1.1);
        }

        .add-child-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }

        .add-child-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .setup-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .setup-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .setup-btn-primary {
            background: #5b7fff;
            color: white;
            box-shadow: 0 4px 15px rgba(91, 127, 255, 0.3);
        }

        .setup-btn-primary:hover {
            background: #4a6ee0;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(91, 127, 255, 0.4);
        }

        .setup-btn-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .setup-btn-secondary:hover {
            background: #e0e0e0;
        }

        .setup-error {
            color: #f44336;
            font-size: 0.9em;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .name-short {
            display: none;
        }

        /* Mobile responsive design for iPhone portrait */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .header {
                gap: 10px;
            }

            .sync-btn {
                width: 40px;
                height: 40px;
            }

            .sync-icon {
                font-size: 1em;
            }

            .mode-buttons {
                flex-direction: column;
                gap: 8px;
                margin-bottom: 20px;
            }

            .mode-btn {
                padding: 10px 20px;
                font-size: 1em;
            }

            .tasks-table th {
                padding: 5px 2px;
                font-size: 0.9em;
                padding-bottom: 10px;
            }

            .tasks-table th:first-child {
                font-size: 1.1em;
                font-weight: 700;
            }

            .name-full {
                display: none;
            }

            .name-short {
                display: inline;
            }


            .tasks-table td {
                padding: 8px 2px;
                font-size: 0.9em;
            }

            .tasks-table td:first-child {
                font-size: 1em;
                min-width: auto;
                padding-left: 5px;
            }

            .task-checkbox {
                width: 20px;
                height: 20px;
                transform: scale(1.5);
            }

            .task-input {
                padding: 4px 8px;
                font-size: 0.8em;
            }

            .btn {
                padding: 4px 8px;
                font-size: 0.7em;
                margin: 1px;
            }

            .btn-move {
                min-width: 20px;
                font-size: 0.8em;
            }

            .add-task-form {
                padding: 15px;
                gap: 8px;
            }

            .add-task-input {
                padding: 8px 12px;
                font-size: 0.9em;
            }

            .add-task-btn {
                padding: 8px 20px;
                font-size: 0.9em;
            }

            .message-area {
                margin-top: 20px;
                padding: 15px;
            }

            .message-textarea {
                min-height: 80px;
                font-size: 0.9em;
            }

            .emoji-picker {
                padding: 40px 20px 80px 20px;
                grid-template-columns: repeat(8, 1fr);
                gap: 15px;
            }

            .emoji-option {
                font-size: 1.5em;
                width: 40px;
                height: 40px;
            }

            .message-history {
                margin-top: 15px;
                padding: 12px;
            }

            .message-history-header {
                font-size: 1em;
                margin-bottom: 12px;
            }

            .history-count {
                font-size: 0.7em;
                padding: 1px 6px;
            }

            .message-history-list {
                max-height: 200px;
            }

            .history-item {
                padding: 10px 12px;
                margin-bottom: 8px;
            }

            .history-item-header {
                font-size: 0.8em;
            }

            .history-btn {
                padding: 3px 6px;
                font-size: 0.7em;
            }

            .history-message {
                font-size: 0.85em;
                max-height: 45px;
                -webkit-line-clamp: 2;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <span style="font-size: 2.5em;">üåÖ</span>
        <h1>Morning Todo List</h1>
        <button class="sync-btn" id="syncBtn" onclick="syncFromCloud()" title="Sync from cloud">
            <span class="sync-icon">‚òÅÔ∏èüîÑ</span>
        </button>
    </div>

    <div class="mode-buttons">
        <button class="mode-btn todo-mode" id="todoModeBtn">Todo Mode</button>
        <button class="mode-btn inactive" id="editModeBtn">Edit Mode</button>
    </div>

<table class="tasks-table" id="tasksTable">
        <thead>
            <tr>
                <th id="dayHeader"></th>
                <th><span class="name-full">Ruthie</span><span class="name-short">Ruth</span></th>
                <th>Lily</th>
                <th>Allie</th>
            </tr>
        </thead>
        <tbody id="tasksList">
        </tbody>
    </table>

    <div class="reset-button-container hidden" id="resetButtonContainer">
        <button class="reset-btn" onclick="resetAllTasks()">Reset All Tasks</button>
    </div>

    <div class="add-task-form hidden" id="addTaskForm">
        <input type="text" class="add-task-input" id="newTaskInput" placeholder="Enter new task...">
        <button class="add-task-btn" onclick="addTask()">Add Task</button>
    </div>

    <div class="message-area" id="messageArea">
        <div class="message-header">
            <span>üíù</span>
            <span>Message from Mom</span>
        </div>
        <textarea
            class="message-textarea hidden"
            id="messageTextarea"
            placeholder="Write a loving message, reminder, or encouragement for your kids... ‚ù§Ô∏è"
            oninput="updateMessage(); debouncedSave();"
            onblur="clearTimeout(saveTimeout); updateMessage(); saveMessageToHistory(); saveToCloud();"
        ></textarea>
        <div class="message-display" id="messageDisplay"></div>

        <!-- Message History (only visible in Edit Mode) -->
        <div class="message-history hidden" id="messageHistory">
            <div class="message-history-header">
                <span>üìù</span>
                <span>Previous Messages</span>
                <span class="history-count" id="historyCount"></span>
            </div>
            <div class="message-history-list" id="messageHistoryList">
                <!-- History items will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Celebration Overlay -->
<div class="celebration-overlay" id="celebrationOverlay"></div>

<!-- Setup Wizard Overlay -->
<div class="setup-overlay" id="setupOverlay">
    <div class="setup-wizard">
        <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Welcome to Your Family Todo App!</h2>
        <p>Let's set up your children's names to get started. You can add, remove, or edit these names.</p>
        
        <div class="children-setup" id="childrenSetup">
            <!-- Children input fields will be added here by JavaScript -->
        </div>
        
        <button class="add-child-btn" id="addChildBtn" onclick="addChildInput()">+ Add Another Child</button>
        
        <div class="setup-error hidden" id="setupError">
            Please enter at least one child's name.
        </div>
        
        <div class="setup-buttons">
            <button class="setup-btn setup-btn-secondary" onclick="skipSetup()">Use Default Names</button>
            <button class="setup-btn setup-btn-primary" onclick="completeSetup()">Save & Continue</button>
        </div>
    </div>
</div>

<script>
    let currentMode = 'todo';
    let currentPerson = 'ruthie';
    let isDragging = false;
    let motherMessage = "Good morning, my beautiful children! Remember to be kind to each other and have a wonderful day! ‚ù§Ô∏è";
    let messageHistory = [];

    // Celebration tracking - prevent repeat celebrations
    let celebratedToday = {
        ruthie: false,
        lily: false,
        allie: false
    };

    // Configuration System
    // Uses config.js file that's included in the repository
    const CONFIG = window.APP_CONFIG || {
        JSONBIN_API_KEY: 'YOUR_API_KEY_HERE',
        JSONBIN_BIN_ID: 'YOUR_BIN_ID_HERE', 
        APP_TITLE: 'Morning Todo List',
        APP_EMOJI: 'üåÖ'
    };
    
    // Family Data Structure
    let familyChildren = [
        { name: "Ruthie", shortName: "Ruth", id: "ruthie" },
        { name: "Lily", shortName: "Lily", id: "lily" }, 
        { name: "Allie", shortName: "Allie", id: "allie" }
    ];

    // Cloud Storage Functions
    async function saveToCloud() {
        const dataToSave = {
            version: 1,
            tasks: tasks,
            motherMessage: motherMessage,
            messageHistory: messageHistory,
            celebratedToday: celebratedToday,
            children: familyChildren,
            migrated: true,
            lastUpdated: new Date().toISOString()
        };

        try {
            // Show loading state
            setLoadingState(true, 'Saving...');

            // Check if API credentials are configured  
            if (CONFIG.JSONBIN_API_KEY === 'YOUR_API_KEY_HERE' || CONFIG.JSONBIN_BIN_ID === 'YOUR_BIN_ID_HERE') {
                showMessage('Please edit config.js with your JSONBin credentials', 'warning');
                // Save to localStorage only
                saveToLocalStorage(dataToSave);
                return;
            }

            // Update existing bin
            const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': CONFIG.JSONBIN_API_KEY
                },
                body: JSON.stringify(dataToSave)
            });

            if (response.ok) {
                showMessage('Data saved to cloud!', 'success');
            }

            if (!response.ok) {
                throw new Error(`Cloud save failed: ${response.status}`);
            }

            // Also save to localStorage as backup
            saveToLocalStorage(dataToSave);

        } catch (error) {
            console.error('Cloud save error:', error);
            // Fall back to localStorage
            saveToLocalStorage(dataToSave);
            showMessage('Saved locally (cloud unavailable)', 'warning');
        } finally {
            setLoadingState(false);
        }
    }

    async function loadFromCloud() {
        try {
            setLoadingState(true, 'Loading...');

            if (CONFIG.JSONBIN_API_KEY === 'YOUR_API_KEY_HERE' || CONFIG.JSONBIN_BIN_ID === 'YOUR_BIN_ID_HERE') {
                // API not configured, use localStorage
                showMessage('Edit config.js with your JSONBin credentials for cloud sync', 'warning');
                return loadFromLocalStorage();
            }

            const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}/latest`, {
                method: 'GET',
                headers: {
                    'X-Master-Key': CONFIG.JSONBIN_API_KEY
                }
            });

            if (response.ok) {
                const result = await response.json();
                const data = result.record;

                if (data.version === 1 && data.tasks && data.motherMessage !== undefined) {
                    tasks = data.tasks;
                    motherMessage = data.motherMessage;
                    messageHistory = data.messageHistory || [];
                    celebratedToday = data.celebratedToday || {};
                    
                    // Load children if available
                    if (data.children && data.children.length > 0) {
                        familyChildren = data.children;
                    }
                    
                    showMessage('Data loaded from cloud!', 'success');
                    return true;
                }
            } else {
                throw new Error(`Cloud load failed: ${response.status}`);
            }
        } catch (error) {
            console.error('Cloud load error:', error);
            // Fall back to localStorage
            const loaded = loadFromLocalStorage();
            if (loaded) {
                showMessage('Loaded from local storage', 'warning');
            }
            return loaded;
        } finally {
            setLoadingState(false);
        }

        return false;
    }

    // Manual sync function for the sync button
    async function syncFromCloud() {
        const syncBtn = document.getElementById('syncBtn');
        const syncIcon = syncBtn.querySelector('.sync-icon');

        // Add spinning animation
        syncBtn.classList.add('syncing');
        syncBtn.disabled = true;

        try {
            const success = await loadFromCloud();
            if (success) {
                // Refresh the UI
                renderTasks();
                updateMessageDisplay();
                showMessage('Synced from cloud!', 'success');
            } else {
                showMessage('Sync failed - using local data', 'warning');
            }
        } catch (error) {
            console.error('Manual sync error:', error);
            showMessage('Sync error - using local data', 'error');
        } finally {
            // Remove spinning animation
            syncBtn.classList.remove('syncing');
            syncBtn.disabled = false;
        }
    }

    // Migration and Setup Functions
    function needsMigration(data) {
        return !data.migrated || !data.children || data.children.length === 0;
    }

    function extractChildrenFromTasks(tasks) {
        // Extract child IDs from existing task structure
        const childIds = Object.keys(tasks || {});
        return childIds.map(id => ({
            id: id,
            name: capitalizeFirst(id),
            shortName: id === 'ruthie' ? 'Ruth' : capitalizeFirst(id)
        }));
    }

    function capitalizeFirst(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    async function checkAndMigrate() {
        try {
            const loaded = await loadFromCloud();
            const savedData = localStorage.getItem('kidsTodoData');
            
            let needsSetup = false;
            
            if (loaded || savedData) {
                // We have existing data, check if it needs migration
                let data = null;
                if (savedData) {
                    try {
                        data = JSON.parse(savedData);
                    } catch (e) {
                        console.log('Error parsing localStorage data:', e);
                    }
                }
                
                if (data && needsMigration(data)) {
                    // Extract children from existing tasks
                    const extractedChildren = extractChildrenFromTasks(data.tasks);
                    if (extractedChildren.length > 0) {
                        // Pre-populate setup wizard with existing children
                        showSetupWizard(extractedChildren);
                        return true; // Return true to indicate setup is needed
                    } else {
                        needsSetup = true;
                    }
                }
            } else {
                // No existing data, show setup wizard
                needsSetup = true;
            }
            
            if (needsSetup) {
                showSetupWizard();
                return true;
            }
            
            return false; // No setup needed
            
        } catch (error) {
            console.error('Migration check error:', error);
            // If there's an error, show setup wizard as fallback
            showSetupWizard();
            return true;
        }
    }

    function showSetupWizard(existingChildren = null) {
        const overlay = document.getElementById('setupOverlay');
        const setupArea = document.getElementById('childrenSetup');
        
        // Clear existing inputs
        setupArea.innerHTML = '';
        
        // Use existing children or defaults
        const childrenToShow = existingChildren || [
            { name: "Child 1", shortName: "C1", id: "child1" },
            { name: "Child 2", shortName: "C2", id: "child2" },
            { name: "Child 3", shortName: "C3", id: "child3" }
        ];
        
        // Add input fields for each child
        childrenToShow.forEach((child, index) => {
            addChildInputField(child.name, index);
        });
        
        // Show the overlay
        overlay.classList.add('active');
        
        // Focus first input
        setTimeout(() => {
            const firstInput = setupArea.querySelector('.child-input');
            if (firstInput) {
                firstInput.focus();
            }
        }, 300);
    }

    function addChildInput() {
        const setupArea = document.getElementById('childrenSetup');
        const currentCount = setupArea.children.length;
        addChildInputField('', currentCount);
        
        // Focus the new input
        const newInput = setupArea.lastElementChild.querySelector('.child-input');
        if (newInput) {
            newInput.focus();
        }
    }

    function addChildInputField(name = '', index = 0) {
        const setupArea = document.getElementById('childrenSetup');
        
        const inputGroup = document.createElement('div');
        inputGroup.className = 'child-input-group';
        
        const input = document.createElement('input');
        input.className = 'child-input';
        input.type = 'text';
        input.value = name;
        input.placeholder = `Child ${index + 1} name...`;
        input.addEventListener('input', validateSetup);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-child-btn';
        removeBtn.innerHTML = '√ó';
        removeBtn.onclick = () => {
            if (setupArea.children.length > 1) {
                inputGroup.remove();
                validateSetup();
            }
        };
        
        inputGroup.appendChild(input);
        inputGroup.appendChild(removeBtn);
        setupArea.appendChild(inputGroup);
        
        validateSetup();
    }

    function validateSetup() {
        const setupArea = document.getElementById('childrenSetup');
        const errorDiv = document.getElementById('setupError');
        const inputs = setupArea.querySelectorAll('.child-input');
        
        let hasErrors = false;
        const names = [];
        
        inputs.forEach(input => {
            const name = input.value.trim();
            input.classList.remove('error');
            
            if (name === '') {
                hasErrors = true;
                input.classList.add('error');
            } else if (names.includes(name.toLowerCase())) {
                hasErrors = true;
                input.classList.add('error');
            } else {
                names.push(name.toLowerCase());
            }
        });
        
        if (names.length === 0) {
            hasErrors = true;
            errorDiv.textContent = 'Please enter at least one child\'s name.';
        } else if (names.length !== new Set(names).size) {
            hasErrors = true;
            errorDiv.textContent = 'Each child must have a unique name.';
        } else {
            errorDiv.textContent = '';
        }
        
        if (hasErrors) {
            errorDiv.classList.remove('hidden');
        } else {
            errorDiv.classList.add('hidden');
        }
        
        return !hasErrors;
    }

    function skipSetup() {
        // Use default children
        familyChildren = [
            { name: "Ruthie", shortName: "Ruth", id: "ruthie" },
            { name: "Lily", shortName: "Lily", id: "lily" }, 
            { name: "Allie", shortName: "Allie", id: "allie" }
        ];
        
        completeSetupProcess();
    }

    function completeSetup() {
        if (!validateSetup()) {
            return; // Don't proceed if validation fails
        }
        
        // Collect children from inputs
        const setupArea = document.getElementById('childrenSetup');
        const inputs = setupArea.querySelectorAll('.child-input');
        
        familyChildren = Array.from(inputs).map((input, index) => {
            const name = input.value.trim();
            const shortName = name.length > 6 ? name.substring(0, 4) : name;
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '') || `child${index + 1}`;
            
            return { name, shortName, id };
        });
        
        completeSetupProcess();
    }

    function completeSetupProcess() {
        // Hide setup wizard
        document.getElementById('setupOverlay').classList.remove('active');
        
        // Update currentPerson to first child
        currentPerson = familyChildren[0]?.id || 'child1';
        
        // Create/update tasks structure for all children
        const newTasks = {};
        familyChildren.forEach(child => {
            newTasks[child.id] = [
                { name: 'Brush teeth', emoji: 'ü¶∑', completed: createCompletionObject(false) },
                { name: 'Get dressed', emoji: 'üëî', completed: createCompletionObject(false) },
                { name: 'Eat breakfast', emoji: 'üç≥', completed: createCompletionObject(false) }
            ];
        });
        
        tasks = newTasks;
        
        // Reset celebration tracking for all children
        celebratedToday = {};
        familyChildren.forEach(child => {
            celebratedToday[child.id] = false;
        });
        
        // Update page title and UI
        updatePageTitle();
        updateTableStructure();
        renderTasks();
        updateMessageDisplay();
        
        // Save to cloud
        saveToCloud();
        
        showMessage('Family setup complete!', 'success');
    }

    function createCompletionObject(defaultValue = false) {
        const completion = {};
        familyChildren.forEach(child => {
            completion[child.id] = defaultValue;
        });
        return completion;
    }

    function updatePageTitle() {
        document.title = CONFIG.APP_TITLE;
        const titleElement = document.querySelector('h1');
        if (titleElement) {
            titleElement.textContent = CONFIG.APP_TITLE;
        }
        
        const emojiElement = document.querySelector('.header span');
        if (emojiElement) {
            emojiElement.textContent = CONFIG.APP_EMOJI;
        }
    }

    function updateTableStructure() {
        // Update table header
        const headerRow = document.querySelector('.tasks-table thead tr');
        
        // Clear existing headers except the first (task name)
        while (headerRow.children.length > 1) {
            headerRow.removeChild(headerRow.lastChild);
        }
        
        // Add headers for each child
        familyChildren.forEach(child => {
            const th = document.createElement('th');
            th.innerHTML = `<span class="name-full">${child.name}</span><span class="name-short">${child.shortName}</span>`;
            headerRow.appendChild(th);
        });
        
        // Add actions header in edit mode
        if (currentMode === 'edit') {
            const actionsHeader = document.createElement('th');
            actionsHeader.className = 'actions-header';
            actionsHeader.textContent = 'Actions';
            headerRow.appendChild(actionsHeader);
        }
    }

    // localStorage backup functions
    function saveToLocalStorage(dataToSave = null) {
        if (!dataToSave) {
            dataToSave = {
                version: 1,
                tasks: tasks,
                motherMessage: motherMessage,
                messageHistory: messageHistory,
                celebratedToday: celebratedToday,
                children: familyChildren,
                migrated: true
            };
        }
        localStorage.setItem('kidsTodoData', JSON.stringify(dataToSave));
    }

    function loadFromLocalStorage() {
        try {
            const savedData = localStorage.getItem('kidsTodoData');
            if (savedData) {
                const data = JSON.parse(savedData);
                if (data.version === 1 && data.tasks && data.motherMessage !== undefined) {
                    tasks = data.tasks;
                    motherMessage = data.motherMessage;
                    messageHistory = data.messageHistory || [];
                    celebratedToday = data.celebratedToday || {};
                    
                    // Load children if available
                    if (data.children && data.children.length > 0) {
                        familyChildren = data.children;
                    }
                    
                    return true;
                }
            }
        } catch (e) {
            console.log('Error loading from localStorage:', e);
        }
        return false;
    }

    // UI feedback functions
    function setLoadingState(loading, message = '') {
        const container = document.querySelector('.container');
        if (loading) {
            container.style.opacity = '0.7';
            if (message) {
                showMessage(message, 'info');
            }
        } else {
            container.style.opacity = '1';
        }
    }

    function showMessage(text, type = 'info') {
        // Remove existing messages
        const existingMessage = document.querySelector('.toast-message');
        if (existingMessage) {
            existingMessage.remove();
        }

        const message = document.createElement('div');
        message.className = `toast-message toast-${type}`;
        message.textContent = text;
        message.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: ${type === 'success' ? '#4caf50' : type === 'warning' ? '#ff9800' : '#2196f3'};
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        `;

        document.body.appendChild(message);

        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (message.parentNode) {
                message.style.opacity = '0';
                message.style.transform = 'translateX(-50%) translateY(-10px)';
                setTimeout(() => message.remove(), 300);
            }
        }, 3000);
    }

    let tasks = {
        ruthie: [
            { name: 'Brush teeth', emoji: 'ü¶∑', completed: { ruthie: false, lily: false, allie: null } },
            { name: 'Get dressed', emoji: 'üëî', completed: { ruthie: false, lily: false, allie: false } },
            { name: 'Eat breakfast', emoji: 'üç≥', completed: { ruthie: false, lily: false, allie: false } }
        ],
        lily: [
            { name: 'Brush teeth', emoji: 'ü¶∑', completed: { ruthie: false, lily: false, allie: null } },
            { name: 'Get dressed', emoji: 'üëî', completed: { ruthie: false, lily: false, allie: false } },
            { name: 'Eat breakfast', emoji: 'üç≥', completed: { ruthie: false, lily: false, allie: false } }
        ],
        allie: [
            { name: 'Brush teeth', emoji: 'ü¶∑', completed: { ruthie: false, lily: false, allie: null } },
            { name: 'Get dressed', emoji: 'üëî', completed: { ruthie: false, lily: false, allie: false } },
            { name: 'Eat breakfast', emoji: 'üç≥', completed: { ruthie: false, lily: false, allie: false } }
        ]
    };

    // Celebration Functions
    function checkForCompletion(person) {
        // Only check in todo mode and if not already celebrated today
        if (currentMode !== 'todo' || celebratedToday[person]) {
            return false;
        }

        const personTasks = tasks[person] || [];

        // Check if all applicable tasks (non-null) are completed
        let applicableTasks = 0;
        let completedTasks = 0;

        personTasks.forEach(task => {
            if (task.completed[person] !== null) {
                applicableTasks++;
                if (task.completed[person] === true) {
                    completedTasks++;
                }
            }
        });

        // Must have at least one applicable task and all must be completed
        return applicableTasks > 0 && completedTasks === applicableTasks;
    }

    function showCelebration(person) {
        // Mark as celebrated to prevent repeats
        celebratedToday[person] = true;

        const overlay = document.getElementById('celebrationOverlay');
        
        // Find the person name from familyChildren
        const child = familyChildren.find(c => c.id === person);
        const personName = child ? child.name : person;

        // Clear any existing celebration content
        overlay.innerHTML = '';

        // Create celebration message
        const messageDiv = document.createElement('div');
        messageDiv.className = 'celebration-message';
        messageDiv.innerHTML = `üéâ Great job, ${personName}! üåü<br>All done! `;

        // Create floating emojis
        const celebrationEmojis = ['üéâ', '‚≠ê', 'üåü', 'üéä', '‚ú®', 'üèÜ', 'üíñ', 'üéà'];

        for (let i = 0; i < 8; i++) {
            const emoji = document.createElement('div');
            emoji.className = 'celebration-emoji';
            emoji.textContent = celebrationEmojis[i % celebrationEmojis.length];

            // Random positioning around the screen
            emoji.style.left = Math.random() * 80 + 10 + '%';
            emoji.style.top = Math.random() * 60 + 20 + '%';
            emoji.style.animationDelay = (Math.random() * 0.5) + 's';

            overlay.appendChild(emoji);
        }

        // Create fireworks
        for (let i = 0; i < 24; i++) {
            const firework = document.createElement('div');
            firework.className = 'firework';

            // Position fireworks in a burst pattern from center
            const angle = (i / 24) * 360;
            const distance = 100 + Math.random() * 100;
            const centerX = 50;
            const centerY = 50;

            const x = centerX + Math.cos(angle * Math.PI / 180) * distance;
            const y = centerY + Math.sin(angle * Math.PI / 180) * distance;

            firework.style.left = x + '%';
            firework.style.top = y + '%';
            firework.style.animationDelay = (Math.random() * 0.5) + 's';

            overlay.appendChild(firework);
        }

        overlay.appendChild(messageDiv);

        // Show the celebration
        overlay.classList.add('active');

        // Auto-hide after 3 seconds
        setTimeout(() => {
            overlay.classList.remove('active');
            setTimeout(() => {
                overlay.innerHTML = '';
            }, 500); // Wait for fade-out transition
        }, 5000);
    }

    // Mode switching
    document.getElementById('todoModeBtn').addEventListener('click', () => {
        // Save message when switching from edit mode
        if (currentMode === 'edit') {
            clearTimeout(saveTimeout);
            updateMessage();
            saveMessageToHistory();
            saveToCloud();
        }

        currentMode = 'todo';
        document.getElementById('todoModeBtn').className = 'mode-btn todo-mode';
        document.getElementById('editModeBtn').className = 'mode-btn inactive';
        document.getElementById('addTaskForm').classList.add('hidden');
        document.getElementById('resetButtonContainer').classList.remove('hidden');

        // Message area - show display, hide textarea
        document.getElementById('messageTextarea').classList.add('hidden');
        document.getElementById('messageDisplay').classList.remove('hidden');
        document.getElementById('messageHistory').classList.add('hidden');
        updateMessageDisplay();

        updateTableHeader();
        renderTasks();
    });

    document.getElementById('editModeBtn').addEventListener('click', () => {
        currentMode = 'edit';
        document.getElementById('todoModeBtn').className = 'mode-btn inactive';
        document.getElementById('editModeBtn').className = 'mode-btn edit-mode';
        document.getElementById('addTaskForm').classList.remove('hidden');
        document.getElementById('resetButtonContainer').classList.add('hidden');

        // Message area - show textarea, hide display
        document.getElementById('messageTextarea').classList.remove('hidden');
        document.getElementById('messageDisplay').classList.add('hidden');
        document.getElementById('messageHistory').classList.remove('hidden');
        document.getElementById('messageTextarea').value = motherMessage;
        renderMessageHistory();

        updateTableHeader();
        renderTasks();
    });

    function updateTableHeader() {
        // This is now handled by updateTableStructure()
        updateTableStructure();
    }

    // Person tab switching
    document.querySelectorAll('.person-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            document.querySelectorAll('.person-tab').forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            currentPerson = e.target.dataset.person;
            renderTasks();
        });
    });

    function renderTasks() {
        const tasksList = document.getElementById('tasksList');
        tasksList.innerHTML = '';

        const personTasks = tasks[currentPerson];
        if (!personTasks) {
            console.warn(`No tasks found for person: ${currentPerson}`);
            return;
        }

        personTasks.forEach((task, index) => {
            const row = document.createElement('tr');
            row.className = 'task-row';

            // Task name cell
            const nameCell = document.createElement('td');
            if (currentMode === 'edit') {
                // In edit mode, show emoji picker and editable text
                const emojiBtn = document.createElement('button');
                emojiBtn.textContent = task.emoji || 'üìù';
                emojiBtn.style.background = 'none';
                emojiBtn.style.border = 'none';
                emojiBtn.style.fontSize = '1.5em';
                emojiBtn.style.cursor = 'pointer';
                emojiBtn.style.marginRight = '10px';
                emojiBtn.onclick = () => showEmojiPicker(index);

                const taskText = document.createElement('span');
                taskText.textContent = task.name;

                nameCell.appendChild(emojiBtn);
                nameCell.appendChild(taskText);
            } else {
                // In todo mode, show emoji and task name together
                const emoji = task.emoji || '';
                nameCell.textContent = emoji ? `${emoji} ${task.name}` : task.name;
            }
            row.appendChild(nameCell);

            // Dynamic children cells
            familyChildren.forEach(child => {
                const childCell = document.createElement('td');
                
                if (currentMode === 'todo') {
                    if (task.completed[child.id] === null) {
                        childCell.innerHTML = '<span style="color: #999; font-weight: bold;">N/A</span>';
                    } else {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'task-checkbox';
                        checkbox.checked = task.completed[child.id] === true;
                        checkbox.onchange = () => toggleTask(index, child.id);
                        childCell.appendChild(checkbox);
                    }
                } else {
                    const input = document.createElement('div');
                    input.className = 'task-input';
                    const status = task.completed[child.id];

                    // Apply styling based on current status
                    if (status === null) {
                        input.className += ' na';
                        input.textContent = 'N/A';
                        input.style.background = '#999';
                        input.style.color = 'white';
                        input.style.borderColor = '#999';
                    } else if (status === true) {
                        input.textContent = 'Yes';
                        input.style.background = '#4caf50';
                        input.style.color = 'white';
                        input.style.borderColor = '#4caf50';
                    } else { // status === false or undefined
                        input.textContent = 'No';
                        input.style.background = '#f44336';
                        input.style.color = 'white';
                        input.style.borderColor = '#f44336';
                    }

                    // Add click handler with better event handling
                    input.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        cycleTaskStatus(index, child.id);
                    };
                    childCell.appendChild(input);
                }
                row.appendChild(childCell);
            });

            // Add action buttons for edit mode
            if (currentMode === 'edit') {
                const buttonCell = document.createElement('td');

                // Up arrow button
                const upBtn = document.createElement('button');
                upBtn.className = 'btn btn-move';
                upBtn.textContent = '‚Üë';
                upBtn.onclick = () => moveTaskUp(index);
                upBtn.disabled = index === 0;
                upBtn.style.marginRight = '3px';

                // Down arrow button
                const downBtn = document.createElement('button');
                downBtn.className = 'btn btn-move';
                downBtn.textContent = '‚Üì';
                downBtn.onclick = () => moveTaskDown(index);
                downBtn.disabled = index === personTasks.length - 1;
                downBtn.style.marginRight = '5px';

                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-edit';
                editBtn.textContent = 'Edit';
                editBtn.onclick = () => editTask(index);
                editBtn.style.marginRight = '3px';

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-delete';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = () => deleteTask(index);

                buttonCell.appendChild(upBtn);
                buttonCell.appendChild(downBtn);
                buttonCell.appendChild(editBtn);
                buttonCell.appendChild(deleteBtn);
                row.appendChild(buttonCell);
            }

            tasksList.appendChild(row);
        });
    }

    function addTask() {
        const input = document.getElementById('newTaskInput');
        const taskName = input.value.trim();

        if (taskName) {
            const newTask = {
                name: taskName,
                emoji: 'üìù', // Default emoji
                completed: createCompletionObject(false)
            };

            // Add to all people's lists
            familyChildren.forEach(child => {
                if (tasks[child.id]) {
                    tasks[child.id].push({...newTask});
                }
            });

            input.value = '';

            // Re-render immediately to ensure event handlers are properly attached
            renderTasks();
            saveToCloud();
        }
    }

    function editTask(index) {
        const newName = prompt('Edit task name:', tasks[currentPerson][index].name);
        if (newName && newName.trim()) {
            // Update task name for all people
            familyChildren.forEach(child => {
                if (tasks[child.id] && tasks[child.id][index]) {
                    tasks[child.id][index].name = newName.trim();
                }
            });
            renderTasks();
            saveToCloud();
        }
    }

    function deleteTask(index) {
        if (confirm('Are you sure you want to delete this task?')) {
            // Delete from all people's lists
            familyChildren.forEach(child => {
                if (tasks[child.id]) {
                    tasks[child.id].splice(index, 1);
                }
            });
            renderTasks();
            saveToCloud();
        }
    }

    function toggleTask(index, person) {
        // Toggle completion status for the specific person on all task lists
        familyChildren.forEach(child => {
            if (tasks[child.id] && tasks[child.id][index]) {
                tasks[child.id][index].completed[person] = !tasks[child.id][index].completed[person];
            }
        });
        renderTasks();
        saveToCloud();

        // Check for completion and show celebration
        if (checkForCompletion(person)) {
            // Small delay to let the checkbox render first
            setTimeout(() => showCelebration(person), 100);
        }
    }

    function cycleTaskStatus(index, person) {
        // Cycle through: No -> Yes -> N/A -> No

        // Get current status from the first available task list (they should all be identical)
        const firstChildTasks = tasks[familyChildren[0]?.id];
        if (!firstChildTasks || !firstChildTasks[index]) {
            console.error(`Task ${index} not found in tasks array`);
            return;
        }

        const currentStatus = firstChildTasks[index].completed[person];

        let newStatus;
        if (currentStatus === false) {
            // No -> Yes
            newStatus = true;
        } else if (currentStatus === true) {
            // Yes -> N/A (mark as null to indicate not applicable)
            newStatus = null;
        } else if (currentStatus === null) {
            // N/A -> No
            newStatus = false;
        } else {
            // Fallback case - if status is undefined or unexpected, set to false
            newStatus = false;
        }

        // Update the status for this person across all task lists
        familyChildren.forEach(child => {
            if (tasks[child.id] && tasks[child.id][index]) {
                tasks[child.id][index].completed[person] = newStatus;
            }
        });

        renderTasks();
        saveToCloud();
    }

    function resetAllTasks() {
        if (confirm('Are you sure you want to reset all tasks? This will uncheck all checkboxes and clear the message.')) {
            // Reset all tasks to unchecked, but preserve N/A status
            familyChildren.forEach(child => {
                if (tasks[child.id]) {
                    tasks[child.id].forEach(task => {
                        familyChildren.forEach(childForReset => {
                            if (task.completed[childForReset.id] !== null) {
                                task.completed[childForReset.id] = false;
                            }
                        });
                    });
                }
            });

            // Reset celebration tracking so kids can be celebrated again
            celebratedToday = {};
            familyChildren.forEach(child => {
                celebratedToday[child.id] = false;
            });

            // Clear mother's message
            motherMessage = "";
            updateMessageDisplay();

            renderTasks();
            saveToCloud();
        }
    }

    function reorderTasks(fromIndex, toIndex) {
        // Reorder tasks in all person arrays to maintain consistency
        familyChildren.forEach(child => {
            if (tasks[child.id]) {
                const taskArray = tasks[child.id];
                const [movedTask] = taskArray.splice(fromIndex, 1);
                taskArray.splice(toIndex, 0, movedTask);
            }
        });

        // Re-render the tasks to reflect the new order
        renderTasks();
        saveToCloud();
    }

    function moveTaskUp(index) {
        if (index > 0) {
            reorderTasks(index, index - 1);
        }
    }

    function moveTaskDown(index) {
        const taskCount = tasks[currentPerson].length;
        if (index < taskCount - 1) {
            reorderTasks(index, index + 1);
        }
    }


    function showEmojiPicker(taskIndex) {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.className = 'emoji-overlay';

        // Create picker
        const picker = document.createElement('div');
        picker.className = 'emoji-picker';

        // Create close button
        const closeBtn = document.createElement('button');
        closeBtn.className = 'emoji-close-btn';
        closeBtn.textContent = '‚úï';
        closeBtn.style.position = 'fixed';
        closeBtn.style.top = '20px';
        closeBtn.style.right = '20px';
        closeBtn.style.zIndex = '1001';

        const closePicker = () => {
            document.body.removeChild(overlay);
            document.body.removeChild(picker);
            document.body.removeChild(closeBtn);
        };

        closeBtn.onclick = closePicker;
        overlay.onclick = closePicker;

        // Comprehensive task emojis
        const emojis = [
            // Personal care & hygiene
            'ü¶∑', 'ü™•', 'üßº', 'üöø', 'üõÅ', 'üß¥', 'ü™í', 'üíÑ', 'üßª', 'ü™û', 'ü™Æ', 'üíß',

            // Clothing & shoes
            'üëï', 'üëî', 'üß•', 'üëó', 'üëö', 'ü©≥', 'üëñ', 'üß¶', 'üë†', 'üëü', 'ü•ø', 'ü©¥',

            // Food & meals
            'üç≥', 'ü•û', 'üçû', 'ü•ê', 'üçé', 'üçå', 'ü•õ', '‚òï', 'ü•§', 'üß¥', 'üç±', 'üçΩÔ∏è', 'ü•Ñ', 'üç¥',

            // School & homework
            'üìö', '‚úèÔ∏è', 'üéí', 'üìù', 'üìñ', 'üñäÔ∏è', 'üìê', 'üßÆ', 'üíª', 'üñ•Ô∏è',

            // Chores & cleaning
            'üßΩ', 'üßπ', 'üß∫', 'üëï', 'üõèÔ∏è', 'üóëÔ∏è', '‚ôªÔ∏è', 'üß¥', 'ü™£', 'üß§',

            // Pets & animals
            'üê∂', 'üê±', 'üêπ', 'üê∞', 'üê†', 'üêü', 'ü¶é', 'üê¢', 'üê¶', 'ü™∂',

            // Activities & play
            'üß∏', 'üéÆ', '‚öΩ', 'üèÉ', 'üö¥', 'üõ¥', 'üèä', 'üé®', 'üéµ', 'üì∫',

            // Sleep & bedtime
            'üò¥', 'üõèÔ∏è', 'üåô', '‚≠ê', 'üåü', 'üí§', 'üïò', '‚è∞', 'üß∏', 'üìö',

            // General & misc
            'üåà', 'üåû', '‚ù§Ô∏è', '‚ú®', '‚ö°', 'üî•', 'üíé', 'üéÅ', 'üéà', 'üéä'
        ];

        emojis.forEach(emoji => {
            const btn = document.createElement('button');
            btn.className = 'emoji-option';
            btn.textContent = emoji;
            btn.onclick = () => {
                // Update emoji for this task across all people
                familyChildren.forEach(child => {
                    if (tasks[child.id] && tasks[child.id][taskIndex]) {
                        tasks[child.id][taskIndex].emoji = emoji;
                    }
                });
                renderTasks();
                saveToCloud();
                closePicker();
            };
            picker.appendChild(btn);
        });

        // Add elements to DOM
        document.body.appendChild(overlay);
        document.body.appendChild(picker);
        document.body.appendChild(closeBtn);
    }

    function updateMessage() {
        motherMessage = document.getElementById('messageTextarea').value;
    }

    // Message History Functions
    function saveMessageToHistory() {
        if (!motherMessage || motherMessage.trim() === '') return;

        const trimmedMessage = motherMessage.trim();

        // Don't save if it's the same as the most recent message
        if (messageHistory.length > 0 && messageHistory[0].message === trimmedMessage) {
            return;
        }

        // Add to beginning of history
        messageHistory.unshift({
            message: trimmedMessage,
            timestamp: new Date().toISOString(),
            dateLabel: formatDateForHistory(new Date())
        });

        // Keep only last 15 messages
        if (messageHistory.length > 15) {
            messageHistory = messageHistory.slice(0, 15);
        }
    }

    function formatDateForHistory(date) {
        const now = new Date();
        const diffTime = now - date;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 0) {
            return 'Today';
        } else if (diffDays === 1) {
            return 'Yesterday';
        } else if (diffDays < 7) {
            return `${diffDays} days ago`;
        } else {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
    }

    function loadMessageFromHistory(index) {
        if (index >= 0 && index < messageHistory.length) {
            const historicalMessage = messageHistory[index].message;
            motherMessage = historicalMessage;
            document.getElementById('messageTextarea').value = historicalMessage;
            updateMessage();
        }
    }

    function deleteMessageFromHistory(index) {
        if (index >= 0 && index < messageHistory.length) {
            const message = messageHistory[index].message;
            const preview = message.length > 50 ? message.substring(0, 50) + '...' : message;

            if (confirm(`Are you sure you want to delete this message?\n\n"${preview}"\n\nThis action cannot be undone.`)) {
                messageHistory.splice(index, 1);
                renderMessageHistory();
                saveToCloud();
            }
        }
    }

    function loadSampleMessage() {
        const sampleMessage = "Good morning, my beautiful children! Remember to be kind to each other and have a wonderful day! I love you all so much! ‚ù§Ô∏è‚ú®";
        motherMessage = sampleMessage;
        document.getElementById('messageTextarea').value = sampleMessage;
        updateMessage();
    }


    function renderMessageHistory() {
        const historyList = document.getElementById('messageHistoryList');
        const historyCount = document.getElementById('historyCount');

        // Update count (always show actual history length)
        historyCount.textContent = messageHistory.length;

        // Clear existing items
        historyList.innerHTML = '';

        if (messageHistory.length === 0) {
            // Show a sample/default message when history is empty
            const sampleMessage = "Good morning, my beautiful children! Remember to be kind to each other and have a wonderful day! I love you all so much! ‚ù§Ô∏è‚ú®";

            const historyItem = document.createElement('div');
            historyItem.className = 'history-item sample-message';

            historyItem.innerHTML = `
                <div class="history-item-header">
                    <span class="history-date">Sample</span>
                    <div class="history-actions">
                        <button class="history-btn history-btn-load" onclick="loadSampleMessage()" title="Load this sample message">
                            Load
                        </button>
                    </div>
                </div>
                <div class="history-message">${sampleMessage}</div>
            `;

            historyList.appendChild(historyItem);
            return;
        }

        // Update date labels for each message (in case time has passed)
        messageHistory.forEach(item => {
            item.dateLabel = formatDateForHistory(new Date(item.timestamp));
        });

        // Render each history item
        messageHistory.forEach((item, index) => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';

            historyItem.innerHTML = `
                <div class="history-item-header">
                    <span class="history-date">${item.dateLabel}</span>
                    <div class="history-actions">
                        <button class="history-btn history-btn-load" onclick="loadMessageFromHistory(${index})" title="Load this message">
                            Load
                        </button>
                        <button class="history-btn history-btn-delete" onclick="deleteMessageFromHistory(${index})" title="Delete this message">
                            √ó
                        </button>
                    </div>
                </div>
                <div class="history-message">${item.message}</div>
            `;

            historyList.appendChild(historyItem);
        });
    }

    // Debounced save to avoid API calls on every keystroke
    let saveTimeout;
    function debouncedSave() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            saveToCloud();
        }, 1500); // Wait 1.5 seconds after user stops typing
    }

    function updateMessageDisplay() {
        document.getElementById('messageDisplay').textContent = motherMessage;
    }

    function updateDayOfWeek() {
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const now = new Date();

        // If it's past noon (12 PM), show tomorrow's day
        if (now.getHours() >= 12) {
            const tomorrow = new Date(now);
            tomorrow.setDate(now.getDate() + 1);
            const dayName = days[tomorrow.getDay()];
            document.getElementById('dayHeader').textContent = dayName;
        } else {
            const dayName = days[now.getDay()];
            document.getElementById('dayHeader').textContent = dayName;
        }
    }

    // Initialize app with cloud storage and migration
    async function initializeApp() {
        // Check for migration needs first
        const needsSetup = await checkAndMigrate();
        
        if (!needsSetup) {
            // No setup needed, proceed normally
            const loaded = await loadFromCloud();
            if (!loaded) {
                // No saved data, save the default data to cloud
                await saveToCloud();
            }
            
            // Update UI with current family configuration
            updatePageTitle();
            updateTableStructure();
            
            // Initial render - start in todo mode
            document.getElementById('resetButtonContainer').classList.remove('hidden');
            renderTasks();
            updateMessageDisplay();
            updateDayOfWeek();
        }
        // If setup is needed, the setup wizard will handle initialization after completion
    }

    // Start the app
    initializeApp();
</script>
</body>
</html>
